## Инструкция по ручному запуску ETL для обновления таблицы currency_history новой валютой.

В данный момент утилита по сбору исторических данных по курсам валют работает в автоматическом режиме, задача `CurrencyHistoryUpdate` запускается Планировщиком Windows каждый день в `06:00`.
Данная инструкция разработана на тот случай, если в системе VitroCAD для ведения Реестра Договоров будет использоваться новая валюта, которая до разработки утилиты ещё не использовалась.

### Шаг 1: Обновление файла конфигурации `config.json` для ручного запуска

1. Найдите файл `config.json` в корневом каталоге проекта.
2. Откройте файл в текстовом редакторе.
3. Найдите параметр `begin_date` и установите значение этого параметра на нужную дату в формате `DD.MM.YYYY`. Если значение оставить пустым в виде `""`, то выгрузка будет получена за текущий день.
4. Найдите параметр `currency_code`, уберите все предыдущие значения, и добавьте новый код валюты CurrencyCode и его соответствующий Rate в эту секцию.
	Значения для параметров можно найти в файле `README.md` в таблице кодов валют.
5. После внесения всех изменений, сохраните файл и закройте текстовый редактор.

Пример файла `config.json` после обновления:
```json
{
  "begin_date": "24.06.2024",
  "end_date": "",
  "currency_code": {
    "CNY": 8
  },
  "connection_string": "your_database_connection_string",
  "mail_message": {
    "from_email": "your_email@example.com",
    "to_emails": ["recipient1@example.com", "recipient2@example.com"],
    "smtp_server": "your_smtp_server",
    "smtp_port": 25
  }
}
```

### Шаг 2: Запуск ETL процесса

1. Найдите файл `etl.bat` в корневом каталоге проекта.
2. Дважды щелкните на файле `etl.bat`, чтобы запустить ваш ETL процесс. Если в ходе выполнения возникнет ошибка, она будет отправлена на электронную почту всем адресам указанным в параметре `to_emails`.

### Шаг 3: Проверка работы ETL процесса

1. Подключитесь к экземпляру базы данных через утилиту SQL Server Managment Studio под текущим пользователем.
2. В левом меню обозревателя найти и раскрыть папку "Базы данных", затем найти БД `Vitro`.
3. Нажав ПКМ по БД `Vitro` выберите пункт контекстного меню "Создать запрос", откроется окно ввода SQL запросов.
4. В это окно необходимо вставить следующий SQL запрос, где значения для фильтров запроса соответствуют значениям параметров `begin_date` и `currency_code` из конфигурационного файла.

Пример запроса:
```sql
select * from currency_history where CurrencyCode = 'CNY' and Date = '24.06.2024'
```

### Шаг 4: Обновление файла конфигурации `config.json` для автоматического запуска
После проверки на обновленные данные необходимо вернуть предыдущие значения кодов валют с учетом добавления новой, для продолжения работы ETL процесса в автоматическом режиме.

1. Найдите файл `config.json` в корневом каталоге проекта.
2. Откройте файл в текстовом редакторе.
3. Найдите параметр `begin_date` и установите значение этого параметра на пустое значение строки `""`.
4. Найдите параметр `currency_code`, добавьте все предыдущие значения, а также добавьте новый код валюты CurrencyCode и его соответствующий Rate в эту секцию.Значения для параметров можно найти в файле `README.md` в таблице кодов валют.
5. После внесения всех изменений, сохраните файл и закройте текстовый редактор.

Пример файла `config.json` после обновления:
```json
{
  "begin_date": "",
  "end_date": "",
  "currency_code": {
	"AUD": 1,
	"USD": 5,
	"EUR": 6,
	"CAD": 7,
	"RUB": 16,
	"CNY": 8
  },
  "connection_string": "your_database_connection_string",
  "mail_message": {
    "from_email": "your_email@example.com",
    "to_emails": ["recipient1@example.com", "recipient2@example.com"],
    "smtp_server": "your_smtp_server",
    "smtp_port": 25
  }
}
```